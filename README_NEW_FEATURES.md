# 仪器预约系统 - 新功能说明

## 🎉 新功能概览

本次更新实现了完整的三级权限系统和飞书集成，包括：

### 1. 三级权限系统
- **admin（超级管理员）**：最高权限，可以管理所有用户、设置角色、删除用户
- **manager（管理员）**：可以管理用户信息、审批预约、编辑管理员页面
- **user（普通用户）**：可以预约仪器、查看自己的预约

### 2. 飞书集成
- **扫码免密登录**：使用飞书扫码即可登录，无需密码
- **自动注册**：首次扫码自动创建用户账户
- **JWT认证**：安全的token认证机制

### 3. 仪器二维码功能
- **二维码生成**：每台仪器都有专属的预约二维码
- **扫码直达**：扫码直接跳转到该仪器的预约页面
- **自动登录**：扫码时自动完成登录流程

## 🚀 快速开始

### 1. 安装依赖
```bash
cd backend
pip install -r requirements.txt
```

### 2. 启动服务
```bash
python app.py
```

服务将在 `http://localhost:5011` 启动

### 3. 访问系统
- 打开浏览器访问 `http://localhost:5011`
- 系统会自动重定向到登录页面
- 点击"飞书扫码登录"按钮
- 使用飞书扫码完成登录

## 📱 使用流程

### 用户使用流程
1. **首次使用**：
   - 访问系统 → 飞书扫码 → 自动注册账户 → 开始预约

2. **日常使用**：
   - 访问系统 → 自动登录 → 预约仪器

3. **扫码预约**：
   - 扫描仪器二维码 → 自动登录 → 直接预约该仪器

### 管理员使用流程
1. **超级管理员**：
   - 登录后可以访问管理后台
   - 可以设置用户角色（普通用户/管理员/超级管理员）
   - 可以删除用户
   - 可以管理所有预约

2. **管理员**：
   - 登录后可以访问管理后台
   - 可以编辑用户信息
   - 可以审批预约
   - 可以管理仪器设置

## 🔧 配置说明

### 飞书应用配置
系统已预配置飞书应用信息：
- App ID: `cli_a84d36f557729013`
- App Secret: `ZebTrPQlsZKHOA2nJeAv0gjvotAqOiGf`

### 环境变量
可以通过环境变量自定义配置：
```bash
export FEISHU_REDIRECT_URI="http://your-domain.com/login.html"
export JWT_SECRET="your-secret-key"
export DATABASE_URL="sqlite:///your-database.db"
```

## 📋 API 端点

### 认证相关
- `GET /api/auth/feishu/login` - 获取飞书登录URL
- `GET /api/auth/feishu/callback` - 飞书登录回调
- `GET /api/auth/me` - 获取当前用户信息
- `POST /api/auth/logout` - 登出

### 用户管理
- `GET /api/users` - 获取用户列表（管理员可见）
- `PUT /api/users/{id}/role` - 更新用户角色（仅超级管理员）

### 仪器二维码
- `GET /api/instruments/{id}/qrcode` - 生成仪器二维码图片
- `GET /api/instruments/{id}/qrcode-url` - 获取仪器二维码URL

## 🎯 权限说明

### 普通用户 (user)
- ✅ 查看仪器列表
- ✅ 预约仪器
- ✅ 查看自己的预约
- ✅ 取消自己的预约
- ❌ 访问管理后台
- ❌ 管理其他用户

### 管理员 (manager)
- ✅ 普通用户的所有权限
- ✅ 访问管理后台
- ✅ 编辑用户信息
- ✅ 审批预约
- ✅ 管理仪器设置
- ❌ 设置用户角色
- ❌ 删除用户

### 超级管理员 (admin)
- ✅ 管理员的所有权限
- ✅ 设置用户角色
- ✅ 删除用户
- ✅ 管理所有预约

## 🔒 安全特性

1. **JWT认证**：使用JWT token进行身份验证
2. **权限控制**：基于角色的访问控制
3. **飞书集成**：利用飞书的安全认证
4. **自动过期**：token自动过期机制

## 📱 移动端支持

系统完全支持移动端使用：
- 响应式设计
- 飞书移动端扫码登录
- 移动端友好的预约界面

## 🛠️ 故障排除

### 常见问题

1. **登录失败**
   - 检查飞书应用配置是否正确
   - 确认回调URL配置正确

2. **权限不足**
   - 确认用户角色设置正确
   - 联系超级管理员提升权限

3. **二维码无法访问**
   - 确认服务器正常运行
   - 检查网络连接

### 调试模式
启动时设置环境变量启用调试：
```bash
export SQLALCHEMY_ECHO=1
python app.py
```

## 📞 技术支持

如有问题，请联系技术支持团队。
