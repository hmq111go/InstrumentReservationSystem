<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ä»ªå™¨ç®¡ç†ä¸é¢„çº¦ - é¦–é¡µ</title>
  <link rel="stylesheet" href="https://unpkg.com/modern-css-reset/dist/reset.min.css" />
  <link rel="stylesheet" href="shared.css" />
  <script src="https://unpkg.com/vue@3.4.27/dist/vue.global.prod.js"></script>
  <script src="https://unpkg.com/axios@1.7.4/dist/axios.min.js"></script>
  <style>
    html { scrollbar-gutter: stable; }
    :root {
      --primary: #007AFF;
      --primary-hover: #0056CC;
      --success: #34C759;
      --warning: #FF9500;
      --danger: #FF3B30;
      --background: #F2F2F7;
      --surface: #FFFFFF;
      --surface-secondary: #F9F9F9;
      --text-primary: #1D1D1F;
      --text-secondary: #86868B;
      --text-tertiary: #C7C7CC;
      --border: #E5E5EA;
      --border-light: #F2F2F7;
      --shadow: 0 1px 3px rgba(0,0,0,0.1), 0 1px 2px rgba(0,0,0,0.06);
      --shadow-lg: 0 10px 15px -3px rgba(0,0,0,0.1), 0 4px 6px -2px rgba(0,0,0,0.05);
      --radius: 12px;
      --radius-sm: 8px;
      --radius-lg: 16px;
    }

    * { box-sizing: border-box; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, "SF Pro Display", "Segoe UI", Roboto, Helvetica, Arial, "PingFang SC", "Hiragino Sans GB", "Microsoft YaHei", sans-serif;
      background: var(--background);
      color: var(--text-primary);
      margin: 0;
      padding: 20px;
      line-height: 1.5;
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
    }

    .grid {
      display: grid;
      grid-template-columns: 200px 1fr;
      gap: 16px;
      max-width: 1400px;
      margin: 0 auto;
    }

    .card {
      background: var(--surface);
      border-radius: var(--radius);
      padding: 20px;
      box-shadow: var(--shadow);
      border: 1px solid var(--border-light);
      transition: color 0.2s ease, background-color 0.2s ease, box-shadow 0.2s ease, border-color 0.2s ease, opacity 0.2s ease;
    }

    .card:hover {
      box-shadow: var(--shadow-lg);
    }

    /* Toolbar layout beautify */
    .toolbar { display: flex; gap: 12px; flex-wrap: wrap; align-items: stretch; margin-bottom: 12px; }
    .field { display: flex; flex-direction: column; gap: 6px; justify-content: flex-end; }
    .field.inline { flex-direction: row; align-items: center; gap: 8px; }
    .label { font-size: 12px; color: #475569; font-weight: 600; }
    .control { height: 44px; display: flex; align-items: center; }
    .control select, .control input { width: 200px; height: 100%; font-size: 15px; }
    @media (max-width: 900px) { .control select, .control input { width: 160px; } }
    @media (max-width: 600px) { .control select, .control input { width: 140px; } }
    .toolbar .btn { height: 40px; }

    /* Cupertino-like controls */
    .cu-control { background: #FFFFFF; border: 1px solid #E5E7EB; border-radius: 12px; padding: 6px 10px; box-shadow: inset 0 1px 0 rgba(255,255,255,0.6); height: 44px; display:flex; align-items:center; overflow: hidden; }
    .cu-control select, .cu-control input[type="text"] { 
      width: 100%; height: 100%; background: transparent; border: none; outline: none; 
      font-size: 15px; color: #0F172A; appearance: none; -webkit-appearance: none; padding: 0 10px; line-height: 1.2; box-shadow: none;
    }
    .cu-control:focus-within { border-color: #93C5FD; box-shadow: 0 0 0 3px rgba(59,130,246,0.15), inset 0 1px 0 rgba(255,255,255,0.6); }
    .cu-select select.placeholder { color: #475569; }

    /* ç´§å‡‘æŒ‰é’®ä¸ä¿¡æ¯å— */
    .btn-compact { padding: 6px 10px; font-size: 13px; font-weight: 600; }
    .btn-ghost-danger { padding: 6px 10px; font-size: 13px; font-weight: 600; color: var(--danger); background: transparent; border: 1px solid rgba(255,59,48,0.35); border-radius: var(--radius-sm); }
    .btn-ghost-danger:hover { background: rgba(255,59,48,0.06); }
    .chips { display: flex; gap: 6px; flex-wrap: wrap; }
    .chip { display: inline-block; padding: 6px 10px; border-radius: 10px; font-size: 15px; font-weight: 600; border: 1px solid var(--border); background: var(--surface-secondary); color: #334155; }
    .chip-primary { background: rgba(0,122,255,0.06); border-color: rgba(0,122,255,0.25); color: #0352ad; }
    .chip-muted { background: #F1F5F9; color: #334155; border-color: #E2E8F0; }

    .btn {
      padding: 12px 20px;
      border: none;
      border-radius: var(--radius-sm);
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      transition: color 0.2s ease, background-color 0.2s ease, box-shadow 0.2s ease, border-color 0.2s ease, opacity 0.2s ease;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
    }

    .btn-primary {
      background: var(--primary);
      color: white;
    }

    .btn-primary:hover:not(:disabled) {
      background: var(--primary-hover);
      transform: translateY(-1px);
    }

    .btn-secondary {
      background: var(--surface-secondary);
      color: var(--text-primary);
      border: 1px solid var(--border);
    }

    .btn-secondary:hover:not(:disabled) {
      background: var(--border-light);
    }

    .btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
      transform: none !important;
    }

    .badge {
      display: inline-block;
      padding: 4px 12px;
      font-size: 12px;
      font-weight: 600;
      border-radius: 12px;
      background: var(--border-light);
      color: var(--text-secondary);
    }

    .badge.active {
      background: rgba(52, 199, 89, 0.1);
      color: var(--success);
    }

    .badge.suspended {
      background: rgba(255, 59, 48, 0.1);
      color: var(--danger);
    }

    .badge.maintenance {
      background: rgba(255, 149, 0, 0.1);
      color: var(--warning);
    }

    .badge.high-usage {
      background: rgba(255, 59, 48, 0.1);
      color: var(--danger);
    }

    .badge.medium-usage {
      background: rgba(255, 149, 0, 0.1);
      color: var(--warning);
    }

    .badge.low-usage {
      background: rgba(52, 199, 89, 0.1);
      color: var(--success);
    }

    .badge.very-low-usage {
      background: var(--border-light);
      color: var(--text-tertiary);
    }

    table {
      width: 100%;
      border-collapse: collapse;
      background: var(--surface);
      border-radius: var(--radius-sm);
      overflow: hidden;
    }

    th, td {
      border-bottom: 1px solid var(--border-light);
      padding: 16px;
      text-align: center;
    }
    th { font-size: 15px; }
    td { font-size: 15px; }

    th {
      background: linear-gradient(180deg, #F8FAFC 0%, #F1F5F9 100%);
      font-weight: 700;
      color: #334155;
      border-bottom: 2px solid var(--border);
      letter-spacing: 0.2px;
      position: sticky;
      top: 0;
      z-index: 1;
    }

    tr:hover {
      background: var(--surface-secondary);
    }

    input, select {
      padding: 12px 16px;
      border: 1px solid var(--border);
      border-radius: var(--radius-sm);
      background: var(--surface);
      font-size: 16px;
      transition: color 0.2s ease, background-color 0.2s ease, box-shadow 0.2s ease, border-color 0.2s ease, opacity 0.2s ease;
    }

    input:focus, select:focus {
      outline: none;
      border-color: var(--primary);
      box-shadow: 0 0 0 3px rgba(0, 122, 255, 0.1);
    }

    a {
      color: var(--primary);
      text-decoration: none;
      padding: 12px 16px;
      border-radius: var(--radius-sm);
      transition: color 0.2s ease, background-color 0.2s ease, box-shadow 0.2s ease, border-color 0.2s ease, opacity 0.2s ease;
      display: block;
    }

    a:hover {
      background: rgba(0, 122, 255, 0.1);
    }

    a.active {
      background: rgba(0, 122, 255, 0.1);
      color: var(--primary);
      font-weight: 600;
    }

    /* Normalize nav link metrics to avoid per-page height drift */
    aside .card a,
    aside .card a.active { line-height: 20px; }

    .link-btn {
      border: none;
      background: none;
      padding: 0;
      color: var(--primary);
      cursor: pointer;
      font-weight: 500;
      transition: all 0.2s ease;
    }

    .link-btn:hover {
      color: var(--primary-hover);
    }

    .pagination {
      display: flex;
      justify-content: center;
      align-items: center;
      gap: 8px;
      margin: 20px 0;
    }

    .pagination button {
      padding: 12px 16px;
      border: 1px solid var(--border);
      background: var(--surface);
      border-radius: var(--radius-sm);
      cursor: pointer;
      color: var(--text-primary);
      font-weight: 500;
      transition: color 0.2s ease, background-color 0.2s ease, box-shadow 0.2s ease, border-color 0.2s ease, opacity 0.2s ease;
    }

    .pagination button:hover:not(:disabled) {
      background: var(--surface-secondary);
      border-color: var(--primary);
    }

    .pagination button:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    .pagination button.active {
      background: var(--primary);
      color: white;
      border-color: var(--primary);
    }

    .pagination-info {
      color: var(--text-secondary);
      font-size: 14px;
      margin: 0 16px;
    }

    /* Navigation sidebar */
    aside {
      position: sticky;
      top: 20px;
      height: fit-content;
    }

    aside .card {
      padding: 16px;
    }

    aside h3 {
      margin: 0 0 16px 0;
      font-size: 18px;
      font-weight: 700;
      color: var(--text-primary);
    }

    /* Smooth animations (avoid animating layout-affecting properties) */
    *, *::before, *::after {
      transition: color 0.2s ease, background-color 0.2s ease, box-shadow 0.2s ease, border-color 0.2s ease, opacity 0.2s ease;
    }

    /* Custom scrollbar */
    ::-webkit-scrollbar {
      width: 6px;
    }

    ::-webkit-scrollbar-track {
      background: var(--border-light);
      border-radius: 3px;
    }

    ::-webkit-scrollbar-thumb {
      background: var(--text-tertiary);
      border-radius: 3px;
    }

    ::-webkit-scrollbar-thumb:hover {
      background: var(--text-secondary);
    }
  </style>
</head>
<body>
<div id="app" class="grid">
  <aside class="card">
    <h3>ä»ªå™¨é¢„çº¦ç®¡ç†å¹³å°</h3>
    <div style="display:flex; flex-direction:column; gap:4px">
      <a href="home.html" :class="{active: isActive('home.html')}">é¢„çº¦é¦–é¡µ</a>
      <a href="reservations.html" :class="{active: isActive('reservations.html')}">æˆ‘çš„é¢„çº¦</a>
      <template v-if="userLoaded">
        <a href="admin_users.html" v-if="isSuperAdmin" :class="{active: isActive('admin_users.html')}">ç”¨æˆ·ç®¡ç†</a>
        <a href="admin_instruments.html" v-if="isManagerOrAdmin" :class="{active: isActive('admin_instruments.html')}">ä»ªå™¨ç®¡ç†</a>
        <a href="admin_reservations.html" v-if="isManagerOrAdmin || isKeeper" :class="{active: isActive('admin_reservations.html')}">é¢„çº¦ç®¡ç†</a>
        <a href="admin_maintenance.html" v-if="isManagerOrAdmin || isKeeper" :class="{active: isActive('admin_maintenance.html')}">ç»´æŠ¤ç®¡ç†</a>
      </template>
    </div>
  </aside>
  <main>
    <div class="card">
      <div class="toolbar">
        <div class="field" style="min-width: 200px; max-width: 300px; flex: 0 0 250px;">
          <span class="label">æœç´¢</span>
          <div class="control cu-control">
            <input type="text" v-model="q" placeholder="æœç´¢ï¼šä»ªå™¨åç§°/å“ç‰Œ/å‹å·" ref="searchInput" />
          </div>
        </div>
        <div class="field" style="flex: 0 0 auto;">
          <div style="display:flex; gap:8px; align-items:center;">
            <button class="btn btn-primary" @click="search" style="height: 44px; font-size: 15px; padding: 0 20px;">æœç´¢</button>
            <button class="btn btn-secondary" @click="resetFilters" style="height: 44px; font-size: 15px; padding: 0 16px;">é‡ç½®</button>
          </div>
        </div>
      </div>
      <div style="margin-bottom:16px; padding:12px; background:var(--surface-secondary); border-radius:var(--radius-sm); font-size:14px; color:var(--text-secondary)">
        ğŸ’¡ é¢„çº¦ç‡è¯´æ˜ï¼šåŸºäºä»Šæ—¥å·¥ä½œæ—¶é—´è®¡ç®—ï¼Œæ˜¾ç¤ºå·²é¢„çº¦æ—¶é—´æ®µå æ€»å¯é¢„çº¦æ—¶é—´çš„ç™¾åˆ†æ¯”ã€‚ä¸‹ä¸€ä¸ªä½¿ç”¨è€…æ˜¾ç¤ºå³å°†ä½¿ç”¨è¯¥ä»ªå™¨çš„ç”¨æˆ·å’Œæ—¶é—´ã€‚
      </div>
        <table>
          <thead>
            <tr>
              <th>ä»ªå™¨åç§°</th>
              <th>å‹å·</th>
              <th>ä½ç½®</th>
              <th>ä¿ç®¡äºº</th>
              <th>ä»ªå™¨çŠ¶æ€</th>
              <th>ä»Šæ—¥é¢„çº¦ç‡</th>
              <th>ä¸‹ä¸€ä¸ªä½¿ç”¨è€…</th>
              <th style="text-align: center;">æ“ä½œ</th>
            </tr>
          </thead>
          <tbody>
            <tr v-for="i in items" :key="i.id">
              <td><span class="chip chip-primary">{{ i.name }}</span></td>
              <td><span class="chip chip-muted">{{ i.model || 'â€”' }}</span></td>
              <td><span class="chip chip-muted">{{ i.location }}</span></td>
              <td><span class="chip">{{ i.keeper_name }}</span></td>
              <td>
                <span v-if="i.current_maintenance" class="badge maintenance">{{ getMaintenanceTypeText(i.current_maintenance.type) }}</span>
                <span v-else-if="i.booking_enabled === 'false'" class="badge suspended">æš‚åœé¢„çº¦</span>
                <span v-else :class="`badge ${i.status}`">{{ getStatusText(i.status) }}</span>
              </td>
              <td>
                <div style="display:flex; justify-content:center;">
                  <div v-if="i.booking_enabled !== 'false' && !i.current_maintenance" style="display:flex; align-items:center; gap:8px">
                    <span :class="getBookingRateClass(i.id)">{{ getBookingRateText(i.id) }}</span>
                    <div v-if="instrumentStats[i.id]" style="font-size:12px; color:var(--text-secondary)">
                      ({{ instrumentStats[i.id].bookedSlots }}/{{ instrumentStats[i.id].totalSlots }})
                    </div>
                  </div>
                  <div v-else-if="i.current_maintenance" style="color:var(--warning)">
                   
                  </div>
                  <div v-else style="color:var(--text-tertiary)">-</div>
                </div>
              </td>
              <td>
                <div v-if="i.current_maintenance" style="font-size:12px; color:var(--warning)">
                  
                </div>

                <div v-else-if="i.booking_enabled !== 'false'" style="font-size:14px; line-height:1.3;">
                  <div style="text-align:center; font-weight:600;">{{ getNextUserName(i.id) }}</div>
                  <div style="text-align:center;">{{ getNextUserTimeCn(i.id) }}</div>
                </div>
                <div v-else style="color:var(--text-tertiary)">-</div>
              </td>
              <td style="text-align: center; vertical-align: middle;">
                <button class="btn btn-primary" @click="goReserve(i.id)" v-if="i.booking_enabled !== 'false' && !i.current_maintenance" style="height: 32px; font-size: 13px; padding: 0 12px;">é¢„çº¦</button>
                <span v-else style="color: var(--text-tertiary); font-size: 13px;">-</span>
              </td>
            </tr>
          </tbody>
        </table>
      </div>
      
      <!-- åˆ†é¡µç»„ä»¶ -->
      <div class="pagination" v-if="pagination && pagination.total_pages > 1">
        <button @click="goToPage(1)" :disabled="!pagination.has_prev">é¦–é¡µ</button>
        <button @click="goToPage(pagination.page - 1)" :disabled="!pagination.has_prev">ä¸Šä¸€é¡µ</button>
        
        <template v-for="page in visiblePages" :key="page">
          <button 
            v-if="page !== '...'" 
            @click="goToPage(page)" 
            :class="{ active: page === pagination.page }"
          >
            {{ page }}
          </button>
          <span v-else class="pagination-info">...</span>
        </template>
        
        <button @click="goToPage(pagination.page + 1)" :disabled="!pagination.has_next">ä¸‹ä¸€é¡µ</button>
        <button @click="goToPage(pagination.total_pages)" :disabled="!pagination.has_next">æœ«é¡µ</button>
        
        <div class="pagination-info">
          å…± {{ pagination.total }} æ¡ï¼Œç¬¬ {{ pagination.page }} / {{ pagination.total_pages }} é¡µ
        </div>
        <div class="field inline">
          <span class="label">æ¯é¡µ</span>
          <div class="control">
            <select v-model="pageSize" @change="onPageSizeChange" style="width:auto">
              <option value="10">10</option>
              <option value="20">20</option>
              <option value="50">50</option>
            </select>
            <span class="label">æ¡</span>
          </div>
        </div>
      </div>
    </main>
  </div>
</div>

<script>
const { createApp, ref, computed } = Vue
createApp({
  setup(){
    const api = ref((location.origin && location.origin!=='null' && location.protocol!=='file:') ? location.origin : (localStorage.getItem('API')||'http://1.13.176.116'))
    const user = ref({})
    const storedRole = ref(localStorage.getItem('role') || '')
    const storedKeeper = ref(localStorage.getItem('is_keeper') || '')
    // ç«‹å³å…è®¸åŸºäºç¼“å­˜ä¿¡æ¯æ¸²æŸ“ä»ªå™¨é¢„çº¦ç®¡ç†å¹³å°ï¼Œé¿å…é—ªçƒ
    const userLoaded = ref(true)
    const currentPageName = ref('home')
    const isActive = (page) => {
      const current = location.pathname.split('/').pop().split('?')[0].split('#')[0]
      return current === page
    }
    const q = ref('')
    const searchInput = ref(null)
    const category = ref('')
    const items = ref([])
    const pagination = ref(null)
    const currentPage = ref(1)
    const pageSize = ref(10)
    const instrumentStats = ref({}) // å­˜å‚¨æ¯ä¸ªä»ªå™¨çš„ç»Ÿè®¡ä¿¡æ¯
    let token = localStorage.getItem('token')
    const headers = () => token ? { 'Authorization': `Bearer ${token}` } : {}
    const isManagerOrAdmin = computed(()=> {
      const role = user.value.role || storedRole.value
      return role==='admin' || role==='super_admin'
    })
    const isSuperAdmin = computed(()=> (user.value.role || storedRole.value)==='super_admin')
    const isKeeper = computed(()=> {
      // å…ˆä½¿ç”¨ç¼“å­˜çš„ä¿ç®¡å‘˜æ ‡è®°ï¼Œå¾…æ‹‰å–ç”¨æˆ·ä¿¡æ¯åè‡ªåŠ¨æ ¡æ­£
      const cached = (storedKeeper.value === 'true')
      return (user.value && user.value.is_keeper) || cached || false
    })

    // åˆ†é¡µç›¸å…³è®¡ç®—å±æ€§
    const visiblePages = computed(() => {
      if (!pagination.value) return []
      const { page, total_pages } = pagination.value
      const pages = []
      
      if (total_pages <= 7) {
        // æ€»é¡µæ•°å°‘äºç­‰äº7é¡µï¼Œæ˜¾ç¤ºæ‰€æœ‰é¡µç 
        for (let i = 1; i <= total_pages; i++) {
          pages.push(i)
        }
      } else {
        // æ€»é¡µæ•°å¤§äº7é¡µï¼Œæ˜¾ç¤ºçœç•¥å·
        if (page <= 4) {
          // å½“å‰é¡µåœ¨å‰4é¡µ
          for (let i = 1; i <= 5; i++) {
            pages.push(i)
          }
          pages.push('...')
          pages.push(total_pages)
        } else if (page >= total_pages - 3) {
          // å½“å‰é¡µåœ¨å4é¡µ
          pages.push(1)
          pages.push('...')
          for (let i = total_pages - 4; i <= total_pages; i++) {
            pages.push(i)
          }
        } else {
          // å½“å‰é¡µåœ¨ä¸­é—´
          pages.push(1)
          pages.push('...')
          for (let i = page - 1; i <= page + 1; i++) {
            pages.push(i)
          }
          pages.push('...')
          pages.push(total_pages)
        }
      }
      
      return pages
    })

    function canEditInstrument(instrument) {
      if (isManagerOrAdmin.value) return true
      return instrument.keeper_id === user.value.id
    }

    function canManageInstrument(instrument) {
      if (isManagerOrAdmin.value) return true
      return instrument.keeper_id === user.value.id
    }

    function getStatusText(status) {
      const statusMap = {
        'active': 'æ­£å¸¸',
        'suspended': 'æš‚åœ',
        'maintenance': 'ç»´æŠ¤ä¸­'
      }
      return statusMap[status] || 'æœªçŸ¥'
    }

    function getMaintenanceTypeText(type) {
      const typeMap = {
        'general': 'æ—¥å¸¸ç»´æŠ¤',
        'repair': 'ç»´ä¿®',
        'calibration': 'æ ¡å‡†',
        'inspection': 'å·¡æ£€'
      }
      return typeMap[type] || 'ç»´æŠ¤'
    }

    function getStatusClass(status) {
      // ç°åœ¨ç›´æ¥ä½¿ç”¨badgeç±»ï¼Œä¸éœ€è¦è¿™ä¸ªå‡½æ•°äº†
      return 'badge'
    }

    async function toggleBooking(instrument) {
      const newStatus = instrument.booking_enabled === 'false' ? 'true' : 'false'
      try {
        await axios.put(`${api.value}/api/instruments/${instrument.id}/booking`, 
          { booking_enabled: newStatus }, 
          { headers: headers() })
        load()
        alert(newStatus === 'true' ? 'å·²å¯ç”¨é¢„çº¦' : 'å·²æš‚åœé¢„çº¦')
      } catch (error) {
        alert('æ“ä½œå¤±è´¥: ' + (error.response?.data?.error || error.message))
      }
    }

    // è®¡ç®—é¢„çº¦ç‡å’Œä¸‹ä¸€ä¸ªä½¿ç”¨è€…
    async function calculateInstrumentStats(instrumentId) {
      try {
        // ä½¿ç”¨åŒ—äº¬æ—¶é—´è®¡ç®—ä»Šå¤©ä¸æ˜å¤©çš„æ—¥æœŸï¼ˆé¿å…è·¨æ—¶åŒºè¯¯å·®ï¼‰
        const getBeijingDates = () => {
          const now = new Date()
          const utcMillis = now.getTime() + now.getTimezoneOffset() * 60000
          const bjNow = new Date(utcMillis + 8 * 60 * 60000)
          const bjYear = bjNow.getUTCFullYear()
          const bjMonth = (bjNow.getUTCMonth() + 1).toString().padStart(2, '0')
          const bjDay = bjNow.getUTCDate().toString().padStart(2, '0')
          const todayStr = `${bjYear}-${bjMonth}-${bjDay}`
          // è®¡ç®—åŒ—äº¬æ—¶é—´çš„æ˜å¤©
          const bjTomorrow = new Date(bjNow.getTime() + 24 * 60 * 60 * 1000)
          const tYear = bjTomorrow.getUTCFullYear()
          const tMonth = (bjTomorrow.getUTCMonth() + 1).toString().padStart(2, '0')
          const tDay = bjTomorrow.getUTCDate().toString().padStart(2, '0')
          const tomorrowStr = `${tYear}-${tMonth}-${tDay}`
          return { todayStr, tomorrowStr }
        }
        const { todayStr, tomorrowStr } = getBeijingDates()
        
        // ä½¿ç”¨æ–°çš„ç»Ÿè®¡API
        const { data: stats } = await axios.get(`${api.value}/api/instruments/${instrumentId}/stats`, {
          params: {
            start_date: todayStr,
            end_date: tomorrowStr
          },
          headers: headers()
        })
        
        console.log(`ä»ªå™¨ ${instrumentId} ç»Ÿè®¡:`, stats)
        
        return {
          bookingRate: stats.booking_rate,
          nextUser: stats.next_user,
          totalSlots: stats.total_slots,
          bookedSlots: stats.booked_slots
        }
      } catch (error) {
        console.error('è®¡ç®—ä»ªå™¨ç»Ÿè®¡ä¿¡æ¯å¤±è´¥:', error)
        return {
          bookingRate: 0,
          nextUser: null,
          totalSlots: 0,
          bookedSlots: 0
        }
      }
    }

    async function load(){
      const { data } = await axios.get(`${api.value}/api/instruments`, { 
        params: { 
          q: q.value, 
          category: category.value,
          page: currentPage.value,
          page_size: pageSize.value
        } 
      })
      items.value = data.items
      pagination.value = data.pagination
      
      // åŒæ­¥ç»´æŠ¤çŠ¶æ€ï¼ˆç®¡ç†å‘˜æƒé™ï¼‰
      if (isManagerOrAdmin.value) {
        try {
          await axios.post(`${api.value}/api/sync-maintenance-status`, {}, { headers: headers() })
        } catch (e) {
          // å¿½ç•¥åŒæ­¥å¤±è´¥ï¼Œä¸å½±å“æ­£å¸¸æ˜¾ç¤º
        }
      }
      
      // ä¸ºæ¯ä¸ªä»ªå™¨è®¡ç®—ç»Ÿè®¡ä¿¡æ¯ï¼ˆå¹¶è¡Œå¤„ç†ä»¥æé«˜æ€§èƒ½ï¼‰
      const statsPromises = data.items
        .filter(item => item.booking_enabled !== 'false')
        .map(async (item) => {
          const stats = await calculateInstrumentStats(item.id)
          return { id: item.id, stats }
        })
      
      const statsResults = await Promise.all(statsPromises)
      statsResults.forEach(({ id, stats }) => {
        instrumentStats.value[id] = stats
      })
    }

    async function del(id){
      if(!confirm('ç¡®å®šåˆ é™¤è¯¥ä»ªå™¨ï¼Ÿ')) return
      await axios.delete(`${api.value}/api/instruments/${id}`, { headers: headers() })
      load()
    }

    function goReserve(instrumentId){
      const target = `index.html#iid=${instrumentId}`
      if (document.startViewTransition) {
        document.startViewTransition(() => { location.href = target })
      } else {
        location.href = target
      }
    }

    // é¦–é¡µä¸å†éœ€è¦äºŒç»´ç æŒ‰é’®

    // åˆ†é¡µç›¸å…³æ–¹æ³•
    function goToPage(page) {
      if (page < 1 || page > pagination.value.total_pages) return
      currentPage.value = page
      load()
    }

    function resetPagination() {
      currentPage.value = 1
    }

    function search() {
      resetPagination()
      load()
    }

    function resetFilters(){
      q.value = ''
      category.value = ''
      resetPagination()
      load()
      try{ searchInput.value && searchInput.value.focus && searchInput.value.focus() }catch(e){}
    }

    function onPageSizeChange() {
      resetPagination()
      load()
    }

    // æ ¼å¼åŒ–æ—¶é—´æ˜¾ç¤º
    function formatTime(timeStr) {
      if (!timeStr) return ''
      const date = new Date(timeStr)
      return `${date.getHours().toString().padStart(2, '0')}:${date.getMinutes().toString().padStart(2, '0')}`
    }

    // è·å–é¢„çº¦ç‡æ˜¾ç¤ºæ–‡æœ¬
    function getBookingRateText(instrumentId) {
      const stats = instrumentStats.value[instrumentId]
      if (!stats) return 'è®¡ç®—ä¸­...'
      return `${stats.bookingRate}%`
    }

    function getNextUserName(instrumentId){
      const stats = instrumentStats.value[instrumentId]
      if(!stats || !stats.nextUser) return 'æ— '
      const name = stats.nextUser.name || 'æ— '
      const notes = stats.nextUser.notes && String(stats.nextUser.notes).trim()
      return notes ? `${name}ï¼ˆ${notes}ï¼‰` : name
    }
    function getNextUserTimeCn(instrumentId){
      const stats = instrumentStats.value[instrumentId]
      if(!stats || !stats.nextUser) return ''
      const nu = stats.nextUser
      const start = nu.start_time || nu.startTime
      const end = nu.end_time || nu.endTime
      if(!start) return ''
      const sd = new Date(start)
      const sm = sd.getMonth()+1
      const sday = sd.getDate()
      const sh = sd.getHours().toString().padStart(2,'0')
      const smin = sd.getMinutes().toString().padStart(2,'0')
      if(end){
        const ed = new Date(end)
        const eh = ed.getHours().toString().padStart(2,'0')
        const emin = ed.getMinutes().toString().padStart(2,'0')
        return `${sm}æœˆ${sday}æ—¥ ${sh}:${smin} - ${eh}:${emin}`
      }
      return `${sm}æœˆ${sday}æ—¥ ${sh}:${smin}`
    }

    // è·å–é¢„çº¦ç‡é¢œè‰²åˆ†ç±»
    function getBookingRateClass(instrumentId) {
      const stats = instrumentStats.value[instrumentId]
      if (!stats) return 'badge'
      
      const rate = stats.bookingRate
      if (rate >= 80) return 'badge high-usage'
      if (rate >= 50) return 'badge medium-usage'
      if (rate >= 20) return 'badge low-usage'
      return 'badge very-low-usage'
    }

    // åˆ·æ–°ç»Ÿè®¡ä¿¡æ¯
    async function refreshStats() {
      const enabledItems = items.value.filter(item => item.booking_enabled !== 'false')
      const statsPromises = enabledItems.map(async (item) => {
        const stats = await calculateInstrumentStats(item.id)
        return { id: item.id, stats }
      })
      
      const statsResults = await Promise.all(statsPromises)
      statsResults.forEach(({ id, stats }) => {
        instrumentStats.value[id] = stats
      })
    }

    // è°ƒè¯•ç»Ÿè®¡ä¿¡æ¯
    async function debugStats() {
      console.log('=== å¼€å§‹è°ƒè¯•ç»Ÿè®¡ä¿¡æ¯ ===')
      const enabledItems = items.value.filter(item => item.booking_enabled !== 'false')
      
      for (const item of enabledItems) {
        console.log(`\n--- è°ƒè¯•ä»ªå™¨: ${item.name} (ID: ${item.id}) ---`)
        
        try {
          // åŒ—äº¬æ—¶åŒºçš„ä»Šå¤©ä¸æ˜å¤©
          const now = new Date()
          const utcMillis = now.getTime() + now.getTimezoneOffset() * 60000
          const bjNow = new Date(utcMillis + 8 * 60 * 60000)
          const y = bjNow.getUTCFullYear()
          const m = (bjNow.getUTCMonth() + 1).toString().padStart(2, '0')
          const d = bjNow.getUTCDate().toString().padStart(2, '0')
          const todayStr = `${y}-${m}-${d}`
          const bjTomorrow = new Date(bjNow.getTime() + 24 * 60 * 60 * 1000)
          const ty = bjTomorrow.getUTCFullYear()
          const tm = (bjTomorrow.getUTCMonth() + 1).toString().padStart(2, '0')
          const td = bjTomorrow.getUTCDate().toString().padStart(2, '0')
          const tomorrowStr = `${ty}-${tm}-${td}`
          
          console.log('æŸ¥è¯¢å‚æ•°:', {
            instrument_id: item.id,
            start_date: todayStr,
            end_date: tomorrowStr
          })
          
          // è·å–ç»Ÿè®¡ä¿¡æ¯
          const { data: stats } = await axios.get(`${api.value}/api/instruments/${item.id}/stats`, {
            params: {
              start_date: todayStr,
              end_date: tomorrowStr
            },
            headers: headers()
          })
          console.log('ç»Ÿè®¡APIå“åº”:', stats)
          
          // è·å–ä»ªå™¨ä¿¡æ¯
          const { data: instrument } = await axios.get(`${api.value}/api/instruments/${item.id}`)
          console.log('ä»ªå™¨ä¿¡æ¯:', instrument)
          
          // è·å–åŸå§‹é¢„çº¦æ•°æ®ï¼ˆç”¨äºå¯¹æ¯”ï¼‰
          const { data: response } = await axios.get(`${api.value}/api/reservations`, {
            params: {
              instrument_id: item.id,
              start_date: todayStr,
              end_date: tomorrowStr
            },
            headers: headers()
          })
          
          const reservations = response.items || response
          console.log('åŸå§‹é¢„çº¦APIå“åº”:', response)
          console.log('é¢„çº¦æ•°æ®:', reservations)
          
          // åˆ†æapprovedé¢„çº¦
          const approvedReservations = reservations.filter(r => r.status === 'approved')
          console.log('Approvedé¢„çº¦:', approvedReservations)
          
        } catch (error) {
          console.error(`è°ƒè¯•ä»ªå™¨ ${item.id} å¤±è´¥:`, error)
        }
      }
      
      console.log('=== è°ƒè¯•å®Œæˆ ===')
    }

    // å¤„ç†ä»å›è°ƒå¸¦å›çš„ token
    ;(function handleCallbackToken(){
      const params = new URLSearchParams(window.location.search)
      const t = params.get('token')
      const ok = params.get('success')
      if(t && ok === 'true'){
        localStorage.setItem('token', t)
        localStorage.setItem('login_time', Date.now().toString())
        token = t
        // æ¸…ç†URL
        window.history.replaceState({}, document.title, window.location.pathname)
        // token åˆ·æ–°åï¼Œç«‹å³æ‹‰å–ç”¨æˆ·å¹¶åˆ·æ–°åˆ—è¡¨
        fetchCurrentUser()
        load()
      }
    })()

    async function fetchCurrentUser(){
      const savedToken = localStorage.getItem('token')
      if (savedToken) {
        try{
          const r = await axios.get(`${api.value}/api/auth/me`, { headers: headers() })
          user.value = r.data
          if(r.data.role){ storedRole.value = r.data.role; localStorage.setItem('role', r.data.role) }
          // ç¼“å­˜ä¿ç®¡å‘˜æ ‡è®°ï¼Œä¾›é¦–å±ä»ªå™¨é¢„çº¦ç®¡ç†å¹³å°æ¸²æŸ“ä½¿ç”¨
          localStorage.setItem('is_keeper', r.data.is_keeper ? 'true' : 'false')
          storedKeeper.value = r.data.is_keeper ? 'true' : 'false'
        }catch(e){ user.value = {}; userLoaded.value = true }
      } else {
        user.value = {}
      }
    }

    // é¦–æ¬¡æ‹‰å–ç”¨æˆ·
    fetchCurrentUser().then(()=>{ userLoaded.value = true; load() })
    // è‹¥é¦–æ¬¡æœªæ‹¿åˆ°è§’è‰²ï¼ŒçŸ­å»¶è¿Ÿé‡è¯•ä¸€æ¬¡ï¼Œé¿å…å¶å‘æ—¶åºå¯¼è‡´é¦–é¡µçœ‹ä¸åˆ°ç®¡ç†å…¥å£
    setTimeout(() => {
      if (!(user.value && user.value.role) && !storedRole.value) {
        const savedToken = localStorage.getItem('token')
        if (savedToken) {
          axios.get(`${api.value}/api/auth/me`, { headers: headers() })
            .then(r => { user.value = r.data; if(r.data.role){ storedRole.value = r.data.role; localStorage.setItem('role', r.data.role) }; localStorage.setItem('is_keeper', r.data.is_keeper ? 'true' : 'false'); storedKeeper.value = r.data.is_keeper ? 'true' : 'false'; userLoaded.value = true; load() })
            .catch(() => { userLoaded.value = true })
        }
      }
    }, 500)

    // æ¢æµ‹ API åœ°å€ï¼Œç¡®ä¿é¦–é¡µèƒ½è¿é€šåç«¯
    async function probeAPI(){
      const candidates = [api.value, localStorage.getItem('API')||'', 'http://1.13.176.116', 'http://127.0.0.1:5011', 'http://localhost:5011'].filter(Boolean)
      for(const base of candidates){
        try{
          await axios.get(`${base}/api/health`)
          api.value = base
          localStorage.setItem('API', base)
          break
        }catch(e){ /* try next */ }
      }
    }

    // å…ˆæ¢æµ‹ API å†åŠ è½½
    probeAPI().then(()=>{ fetchCurrentUser().then(()=> { userLoaded.value = true; load() }) })

    // è‡ªåŠ¨åŠ è½½ï¼ˆå…œåº•ï¼‰
    load()
    
    // æ¯5åˆ†é’Ÿè‡ªåŠ¨åˆ·æ–°ç»Ÿè®¡ä¿¡æ¯
    setInterval(() => {
      if (items.value.length > 0) {
        refreshStats()
      }
    }, 5 * 60 * 1000) // 5åˆ†é’Ÿ
    return { 
      api, user, userLoaded, isManagerOrAdmin, isSuperAdmin, isKeeper, q, category, items, 
      pagination, currentPage, pageSize, visiblePages, instrumentStats,
      load, del, canEditInstrument, canManageInstrument, getStatusText, getMaintenanceTypeText, getStatusClass, 
      toggleBooking, isActive, goToPage, search, resetFilters, onPageSizeChange, goReserve,
      getBookingRateText, getNextUserName, getNextUserTimeCn, getBookingRateClass, formatTime, refreshStats, debugStats
    }
  }
}).mount('#app')
</script>
</script>
<script>
// Smooth same-origin navigation to reduce page jank
document.addEventListener('click', function (e) {
  const anchor = e.target && e.target.closest && e.target.closest('a');
  if (!anchor) return;
  const url = new URL(anchor.href, location.href);
  // Only intercept left-click, same-origin, no modifier keys
  const isLeftClick = (e.button === 0);
  const noModifier = !(e.metaKey || e.ctrlKey || e.shiftKey || e.altKey);
  if (!isLeftClick || !noModifier) return;
  if (url.origin !== location.origin) return;
  e.preventDefault();
  if (document.startViewTransition) {
    document.startViewTransition(() => { location.href = url.href; });
  } else {
    location.href = url.href;
  }
});
</script>
</body>
</html>


