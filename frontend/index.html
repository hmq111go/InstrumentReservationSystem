<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>‰ª™Âô®È¢ÑÁ∫¶Á≥ªÁªü</title>
  <link rel="stylesheet" href="https://unpkg.com/modern-css-reset/dist/reset.min.css" />
  <link rel="stylesheet" href="shared.css" />
  <script src="https://unpkg.com/vue@3.4.27/dist/vue.global.prod.js"></script>
  <script src="https://unpkg.com/axios@1.7.4/dist/axios.min.js"></script>
  <style>
    :root {
      --primary: #007AFF;
      --primary-hover: #0056CC;
      --success: #34C759;
      --warning: #FF9500;
      --danger: #FF3B30;
      --background: #F2F2F7;
      --surface: #FFFFFF;
      --surface-secondary: #F9F9F9;
      --text-primary: #1D1D1F;
      --text-secondary: #86868B;
      --text-tertiary: #C7C7CC;
      --border: #E5E5EA;
      --border-light: #F2F2F7;
      --shadow: 0 1px 3px rgba(0,0,0,0.1), 0 1px 2px rgba(0,0,0,0.06);
      --shadow-lg: 0 10px 15px -3px rgba(0,0,0,0.1), 0 4px 6px -2px rgba(0,0,0,0.05);
      --radius: 12px;
      --radius-sm: 8px;
      --radius-lg: 16px;
    }

    * { box-sizing: border-box; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, "SF Pro Display", "Segoe UI", Roboto, Helvetica, Arial, "PingFang SC", "Hiragino Sans GB", "Microsoft YaHei", sans-serif;
      background: var(--background);
      color: var(--text-primary);
      margin: 0;
      padding: 20px;
      line-height: 1.5;
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
    }

    .layout {
      display: grid;
      grid-template-columns: 320px 1fr;
      gap: 24px;
      max-width: 1400px;
      margin: 0 auto;
    }

    .card {
      background: var(--surface);
      border-radius: var(--radius);
      padding: 20px;
      box-shadow: var(--shadow);
      border: 1px solid var(--border-light);
      transition: all 0.2s ease;
    }

    .card:hover {
      box-shadow: var(--shadow-lg);
    }

    .toolbar {
      display: flex;
      gap: 12px;
      margin-bottom: 16px;
      align-items: center;
    }

    .search-input {
      flex: 1;
      padding: 12px 16px;
      border: 1px solid var(--border);
      border-radius: var(--radius-sm);
      background: var(--surface);
      font-size: 16px;
      transition: all 0.2s ease;
    }

    .search-input:focus {
      outline: none;
      border-color: var(--primary);
      box-shadow: 0 0 0 3px rgba(0, 122, 255, 0.1);
    }

    .btn {
      padding: 12px 20px;
      border: none;
      border-radius: var(--radius-sm);
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s ease;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
    }

    .btn-primary {
      background: var(--primary);
      color: white;
    }

    .btn-primary:hover:not(:disabled) {
      background: var(--primary-hover);
      transform: translateY(-1px);
    }

    .btn-secondary {
      background: var(--surface-secondary);
      color: var(--text-primary);
      border: 1px solid var(--border);
    }

    .btn-secondary:hover:not(:disabled) {
      background: var(--border-light);
    }

    .btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
      transform: none !important;
    }

    .list-item {
      padding: 16px;
      border-bottom: 1px solid var(--border-light);
      cursor: pointer;
      transition: all 0.2s ease;
      border-radius: var(--radius-sm);
      margin-bottom: 4px;
    }

    .list-item:hover {
      background: var(--surface-secondary);
    }

    .list-item.active {
      background: rgba(0, 122, 255, 0.1);
      border: 1px solid var(--primary);
    }

    .grid {
      display: grid;
      grid-template-columns: 80px repeat(7, 1fr);
      border: 1px solid var(--border);
      border-radius: var(--radius-sm);
      overflow: hidden;
      background: var(--surface);
    }

    .slot-track {
      display: grid;
      grid-template-columns: 48px 1fr;
      gap: 12px;
      align-items: start;
    }

    .time-axis {
      display: flex;
      flex-direction: column;
      gap: 12px;
      align-items: center;
      position: relative;
    }

    .time-axis::before {
      content: '';
      position: absolute;
      left: 50%;
      top: 0;
      bottom: 0;
      width: 2px;
      background: var(--border-light);
      transform: translateX(-50%);
      border-radius: 2px;
    }

    .time-marker {
      writing-mode: vertical-rl;
      text-orientation: mixed;
      font-size: 12px;
      color: var(--text-secondary);
      letter-spacing: 2px;
      min-height: 60px;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 4px 0;
      position: relative;
      z-index: 1;
    }

    .slot-column {
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    .slot-single {
      min-height: 60px;
      width: 100%;
      border: 1px solid var(--border);
      border-radius: var(--radius-sm);
      background: var(--surface);
      padding: 10px 14px;
      box-shadow: var(--shadow);
      cursor: pointer;
      transition: transform 0.15s ease, box-shadow 0.15s ease;
      user-select: none;
    }

    .slot-single:hover {
      box-shadow: var(--shadow-lg);
      transform: translateY(-1px);
    }

    .slot-single.free {
      background: rgba(52, 199, 89, 0.08);
      border-color: rgba(52, 199, 89, 0.3);
    }

    .slot-single.booked {
      background: rgba(255, 59, 48, 0.08);
      border-color: rgba(255, 59, 48, 0.3);
    }

    .slot-single.selected {
      border-color: var(--primary);
      background: rgba(0,122,255,0.08);
    }

    .slot-single.blocked {
      background: var(--border-light);
      border-style: dashed;
      color: var(--text-tertiary);
      cursor: not-allowed;
      box-shadow: none;
    }

    .cell {
      height: 24px;
      border-right: 1px solid var(--border-light);
      border-bottom: 1px solid var(--border-light);
      font-size: 11px;
      color: var(--text-secondary);
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.15s ease;
    }

    .cell:last-child {
      border-right: none;
    }

    .cell.booked {
      background: rgba(255, 59, 48, 0.1);
      color: var(--danger);
    }

    .cell.free {
      background: rgba(52, 199, 89, 0.1);
      color: var(--success);
      cursor: pointer;
    }

    .cell.free:hover {
      background: rgba(52, 199, 89, 0.2);
    }

    .cell.blocked {
      background: var(--border-light);
      color: var(--text-tertiary);
    }

    .cell.selected {
      background: var(--primary);
      color: white;
    }

    /* Mobile reserve view */
    .mobile-wrap {
      display: flex;
      flex-direction: column;
      gap: 16px;
      padding: 20px;
    }

    .mobile-header {
      display: flex;
      gap: 16px;
      align-items: center;
    }

    .mobile-photo {
      width: 100px;
      height: 75px;
      overflow: hidden;
      border-radius: var(--radius);
      border: 1px solid var(--border);
      flex-shrink: 0;
      background: var(--surface-secondary);
      display: flex;
      align-items: center;
      justify-content: center;
      color: var(--text-tertiary);
      font-size: 12px;
    }

    .mobile-title {
      font-size: 20px;
      font-weight: 700;
      color: var(--text-primary);
      margin-bottom: 4px;
    }

    .mobile-sub {
      color: var(--text-secondary);
      font-size: 14px;
      margin-bottom: 2px;
    }

    .slot-list {
      max-height: 60vh;
      overflow: auto;
      border: 1px solid var(--border);
      border-radius: var(--radius);
      background: var(--surface);
    }

    .slot-item {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 16px;
      border-bottom: 1px solid var(--border-light);
      font-size: 16px;
      transition: all 0.2s ease;
      cursor: pointer;
    }

    .slot-item:last-child {
      border-bottom: none;
    }

    .slot-item.free {
      background: rgba(52, 199, 89, 0.05);
    }

    .slot-item.free:hover {
      background: rgba(52, 199, 89, 0.1);
    }

    .slot-item.booked {
      background: rgba(255, 59, 48, 0.05);
    }

    .slot-item.selected {
      background: rgba(0, 122, 255, 0.1);
      border: 1px solid var(--primary);
    }

    .badge {
      font-size: 12px;
      padding: 4px 8px;
      border-radius: 12px;
      font-weight: 600;
    }

    .badge.ok {
      background: var(--success);
      color: white;
    }

    .badge.no {
      background: var(--danger);
      color: white;
    }

    .badge.maintenance {
      background: var(--warning);
      color: white;
    }

    .badge.suspended {
      background: var(--danger);
      color: white;
    }

    .mobile-toolbar {
      display: flex;
      gap: 12px;
      align-items: center;
    }

    .mobile-toolbar .btn {
      flex: 1;
    }

    @media (max-width: 768px) {
      body {
        padding: 16px;
      }
      .layout {
        display: block;
      }
      .card {
        padding: 16px;
      }
    }

    /* Smooth animations */
    * {
      transition: all 0.2s ease;
    }

    /* Custom scrollbar */
    ::-webkit-scrollbar {
      width: 6px;
    }

    ::-webkit-scrollbar-track {
      background: var(--border-light);
      border-radius: 3px;
    }

    ::-webkit-scrollbar-thumb {
      background: var(--text-tertiary);
      border-radius: 3px;
    }

    ::-webkit-scrollbar-thumb:hover {
      background: var(--text-secondary);
    }
  </style>
</head>
<body>
<div id="app" class="layout">
  <!-- Desktop/Default view -->
  <template v-if="!isMobileReserve">
  <div class="card">
    <div class="toolbar">
      <input v-model="search" placeholder="ÊêúÁ¥¢‰ª™Âô®" class="search-input" />
      <button @click="loadInstruments" class="btn btn-primary">ÊêúÁ¥¢</button>
    </div>
    <div v-for="i in instruments" :key="i.id" class="list-item" :class="{active: i.id===selectedInstrumentId}" @click="selectInstrument(i.id)">
      <div style="display:flex; gap:8px; align-items:center">
        <div v-if="i.photo_url" style="width:40px;height:30px;overflow:hidden;border-radius:4px;border:1px solid #e5e7eb;flex-shrink:0">
          <img :src="i.photo_url" :alt="i.name" style="width:100%;height:100%;object-fit:cover" />
        </div>
        <div v-else style="width:40px;height:30px;background:#f3f4f6;border:1px solid #e5e7eb;border-radius:4px;display:flex;align-items:center;justify-content:center;color:#9ca3af;font-size:10px;flex-shrink:0">
          Êó†Âõæ
        </div>
        <div style="flex:1">
          <div><strong>{{ i.name }}</strong> <small>{{ i.brand }} {{ i.model }}</small></div>
          <div style="color:#64748b">{{ i.location }}</div>
          <div v-if="i.booking_enabled === 'false'" style="color:#ff3b30; font-size:12px; margin-top:2px">
            <span class="badge suspended">ÊöÇÂÅúÈ¢ÑÁ∫¶</span>
          </div>
        </div>
      </div>
    </div>
  </div>
  <div class="card">
    <div class="toolbar" style="margin-bottom:16px">
      <button @click="goBack" class="btn btn-secondary">‚Üê ËøîÂõû‰∏ä‰∏ÄÈ°µ</button>
    </div>
    <div class="toolbar" style="margin-bottom:16px" v-if="!isLoggedIn">
      <button @click="goToLogin" class="btn btn-primary">
        üöÄ È£û‰π¶ÁôªÂΩï
      </button>
    </div>
    <div class="toolbar" style="margin-bottom:16px" v-else>
      <span style="color: var(--text-secondary); font-weight: 500;">Ê¨¢ËøéÔºå{{ user.name }}</span>
    </div>
    <div class="toolbar">
      <button @click="prevWeek" class="btn btn-secondary">‚óÄ</button>
      <div style="flex:1;text-align:center; font-weight: 600; color: var(--text-primary);">{{ weekTitle }}</div>
      <button @click="thisWeek" class="btn btn-secondary">‰ªäÂ§©</button>
      <button @click="nextWeek" class="btn btn-secondary">‚ñ∂</button>
    </div>
    <div class="slot-track">
      <div class="time-axis">
        <div
          v-for="row in totalRows"
          :key="`axis-${row}`"
          class="time-marker"
        >
          {{ rowStartLabel(row) }}
        </div>
      </div>
      <div class="slot-column" @mouseleave="cancelDrag">
        <div
          v-for="row in totalRows"
          :key="row"
          :data-row="row"
          :class="['slot-single', cellClass(activeDay, row)]"
          :title="cellTooltip(activeDay, row)"
          @mousedown.prevent="onSlotMouseDown(row)"
          @mouseenter="onSlotMouseEnter(row)"
          @mouseup.prevent="onSlotMouseUp"
          @touchstart.prevent="onSlotTouchStart(row)"
          @touchmove.prevent="onSlotTouchMove"
          @touchend="onSlotMouseUp"
        >
          <div style="font-size:12px;color:#475569;font-weight:600">{{ rowLabel(row) }}</div>
          <div style="width:100%;display:flex;flex-direction:column;align-items:flex-start;line-height:1.3;">
            <span>{{ cellLabel(activeDay,row) || 'ÂèØÈ¢ÑÁ∫¶' }}</span>
            <span v-if="cellPending(activeDay,row)" style="font-size:11px;color:#ff9500;margin-top:2px">ÂÆ°Ê†∏‰∏≠</span>
          </div>
        </div>
      </div>
    </div>
    <div style="margin-top:12px; display:flex; gap:8px; align-items:center">
      <button @click="createReservation" :disabled="!canReserve" class="btn btn-primary">È¢ÑÁ∫¶ÊâÄÈÄâ</button>
      <span v-if="selectedRangeText">{{ selectedRangeText }}</span>
    </div>
    <div v-if="canReserve" style="margin-top:12px;">
      <label style="display:block; margin-bottom:8px; font-weight:600; color:var(--text-primary);">È¢ÑÁ∫¶Â§áÊ≥®ÔºàÂèØÈÄâÔºâ</label>
      <textarea v-model="reservationNotes" placeholder="ËØ∑ËæìÂÖ•È¢ÑÁ∫¶Â§áÊ≥®..." style="width:100%; min-height:60px; padding:8px; border:1px solid var(--border); border-radius:var(--radius-sm); font-size:14px; resize:vertical; font-family:inherit;"></textarea>
    </div>
    <div style="margin-top:16px">
      <h3>ÊàëÁöÑÈ¢ÑÁ∫¶</h3>
      <div v-if="myReservations.length === 0" style="color: #64748b; font-size: 14px; padding: 8px 0;">ÊöÇÊó†È¢ÑÁ∫¶</div>
      <div v-for="r in myReservations" :key="r.id" style="display:flex;gap:8px;align-items:center;border-bottom:1px solid #f1f5f9;padding:6px 0">
        <span>[{{ getStatusCn(r.status) }}]</span>
        <span>{{ formatDT(r.start_time) }} ‚Üí {{ formatDT(r.end_time) }}</span>
        <span v-if="r.notes" style="color:#64748b;font-size:12px;max-width:200px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;" :title="r.notes">Â§áÊ≥®: {{ r.notes }}</span>
        <button v-if="user.role==='admin' && r.status!=='approved'" @click="approve(r.id)">ÂÆ°Ê†∏ÈÄöËøá</button>
        <button v-if="user.role==='admin' && r.status!=='rejected'" @click="reject(r.id)">È©≥Âõû</button>
        <button v-if="user.role==='admin' || r.employee_id===user.id" @click="cancel(r.id)">ÂèñÊ∂à</button>
      </div>
    </div>
  </div>
  </template>

  <!-- Mobile reserve view (QR landing) -->
  <template v-else>
    <div class="card mobile-wrap">
      <div class="mobile-header">
        <div class="mobile-photo">
          <img v-if="currentInstrument && currentInstrument.photo_url" :src="currentInstrument.photo_url" :alt="currentInstrument.name" style="width:100%;height:100%;object-fit:cover" />
          <span v-else>Êó†Âõæ</span>
        </div>
        <div style="flex:1">
          <div class="mobile-title">{{ currentInstrument?.name || '‰ª™Âô®ËØ¶ÊÉÖ' }}</div>
          <div class="mobile-sub">{{ currentInstrument?.brand }} {{ currentInstrument?.model }} ¬∑ {{ currentInstrument?.location }}</div>
          <div class="mobile-sub">‰øùÁÆ°ÂëòÔºö{{ currentInstrument?.keeper_name || 'Êó†' }}<span v-if="currentInstrument?.keeper_phone"> ¬∑ <a :href="`tel:${currentInstrument.keeper_phone}`">{{ currentInstrument.keeper_phone }}</a></span></div>
        </div>
      </div>

      <div class="mobile-toolbar">
        <button class="btn btn-secondary" @click="mobilePrevDay">‚óÄ Ââç‰∏ÄÂ§©</button>
        <div style="flex:1; text-align:center; font-weight: 600; color: var(--text-primary);">{{ mobileDateLabel }}</div>
        <button class="btn btn-secondary" @click="mobileNextDay">Âêé‰∏ÄÂ§© ‚ñ∂</button>
      </div>

      <div class="slot-list">
        <div v-for="slot in mobileSlots" :key="slot.key" class="slot-item" :class="slot.className" @click="mobileClickSlot(slot)">
          <div>
            <div style="font-weight:600">{{ slot.label }}</div>
            <div v-if="slot.resv" style="font-size:12px;color:#475569">{{ slot.resv.employee_name }}<span v-if="slot.resv.notes">Ôºà{{ slot.resv.notes }}Ôºâ</span> ¬∑ {{ formatDT(slot.resv.start_time) }}‚Üí{{ formatDT(slot.resv.end_time) }}</div>
            <div v-if="slot.resv && slot.resv.notes" style="font-size:12px;color:#64748b; margin-top:2px" :title="slot.resv.notes">Â§áÊ≥®Ôºö{{ slot.resv.notes }}</div>
          </div>
          <div>
            <span v-if="slot.resv" class="badge no">Â∑≤Á∫¶</span>
            <span v-else class="badge ok">ÂèØÁ∫¶</span>
          </div>
        </div>
      </div>

      <div v-if="canReserve" style="margin:12px 0;">
        <label style="display:block; margin-bottom:8px; font-weight:600; color:var(--text-primary);">È¢ÑÁ∫¶Â§áÊ≥®ÔºàÂèØÈÄâÔºâ</label>
        <textarea v-model="reservationNotes" placeholder="ËØ∑ËæìÂÖ•È¢ÑÁ∫¶Â§áÊ≥®..." style="width:100%; min-height:60px; padding:8px; border:1px solid var(--border); border-radius:var(--radius-sm); font-size:14px; resize:vertical; font-family:inherit;"></textarea>
      </div>

      <div class="mobile-toolbar">
        <button class="btn btn-secondary" @click="goBack">ËøîÂõû</button>
        <button class="btn btn-primary" @click="mobileReserve" :disabled="!canReserve">È¢ÑÁ∫¶ÊâÄÈÄâ</button>
      </div>

      <div>
        <div style="font-weight:600; margin-top:4px; margin-bottom:8px">ÂΩìÊó•È¢ÑÁ∫¶</div>
        <div v-if="dayReservations.length===0" style="color:#64748b; font-size:14px">ÊöÇÊó†È¢ÑÁ∫¶</div>
        <div v-for="r in dayReservations" :key="r.id" style="display:flex; gap:8px; align-items:center; padding:8px 0; border-bottom:1px solid #f1f5f9">
          <span>[{{ getStatusCn(r.status) }}]</span>
          <span>{{ r.employee_name || 'ÂåøÂêç' }}<span v-if="r.notes">Ôºà{{ r.notes }}Ôºâ</span></span>
          <span>{{ formatDT(r.start_time) }} ‚Üí {{ formatDT(r.end_time) }}</span>
        </div>
      </div>
    </div>
  </template>
</div>

<script>
const { createApp, computed, ref, reactive, onMounted, onBeforeUnmount } = Vue

function toISO(dt){ const d=new Date(dt); d.setSeconds(0,0); return d.toISOString() }
function toLocalISOString(dt){
  const d = new Date(dt)
  d.setSeconds(0,0)
  const pad = (n)=> String(n).padStart(2,'0')
  const y = d.getFullYear()
  const m = pad(d.getMonth()+1)
  const day = pad(d.getDate())
  const hh = pad(d.getHours())
  const mm = pad(d.getMinutes())
  const ss = pad(d.getSeconds())
  return `${y}-${m}-${day}T${hh}:${mm}:${ss}`
}
function addMinutes(dt, m){ return new Date(new Date(dt).getTime() + m*60000) }

createApp({
  setup(){
    const defaultBase = (location.origin && location.origin !== 'null' && location.origin !== 'file://') ? location.origin : (localStorage.getItem('API') || 'http://1.13.176.116')
    const api = ref(defaultBase)
    const isLoggedIn = ref(false)
    const user = ref({})
    const token = ref(localStorage.getItem('token'))
    const headers = computed(() => {
      if (token.value) {
        return { 'Authorization': `Bearer ${token.value}` }
      }
      return {}
    })

    const instruments = ref([])
    const employees = ref([])
    const reservations = ref([])
    const selectedInstrumentId = ref(null)
    const currentInstrument = ref(null)
    const windowWidth = ref(window.innerWidth)
    const hasInstrumentIdInURL = ref(false)
    const viewDate = ref(new Date(new Date().setHours(0,0,0,0)))
    const search = ref('')

    const weekdayNames = ['Âë®Êó•','Âë®‰∏Ä','Âë®‰∫å','Âë®‰∏â','Âë®Âõõ','Âë®‰∫î','Âë®ÂÖ≠']

    const weekDays = computed(() => {
      const d = new Date(viewDate.value)
      d.setHours(0, 0, 0, 0)
      const label = `${d.getMonth() + 1}Êúà${d.getDate()}Êó• ${weekdayNames[d.getDay()]}`
      return [{ date: d, label }]
    })
    const activeDay = computed(() => weekDays.value[0])

    const weekTitle = computed(() => {
      const d = new Date(viewDate.value)
      return `${d.getFullYear()}Âπ¥ ${d.getMonth() + 1}Êúà ${d.getDate()}Êó• ${weekdayNames[d.getDay()]}`
    })

    const selection = ref(null) // {start, end}
    const dragState = reactive({ active: false, anchorRow: null })
    const slotMinutes = ref(15)
    const reservationNotes = ref('') // È¢ÑÁ∫¶Â§áÊ≥®

    function parseTimeToMinutes(value) {
      if (!value && value !== 0) return null
      const parts = String(value).split(':')
      const hour = Number(parts[0])
      const minute = parts.length > 1 ? Number(parts[1]) : 0
      if (!Number.isFinite(hour) || hour < 0 || hour > 23) return null
      const safeMinute = Number.isFinite(minute) ? Math.min(Math.max(minute, 0), 59) : 0
      return hour * 60 + safeMinute
    }

    const bookingWindow = computed(() => {
      const step = Number(slotMinutes.value) || 15
      const inst = currentInstrument.value
      const fallbackStart = 8 * 60
      const fallbackEnd = 18 * 60
      const startMinutes = parseTimeToMinutes(inst?.booking_start_time) ?? fallbackStart
      const endMinutes = parseTimeToMinutes(inst?.booking_end_time) ?? fallbackEnd
      let start = Math.max(0, Math.min(startMinutes, (24 * 60) - step))
      let end = Math.max(start + step, Math.min(endMinutes, 24 * 60))
      if (end <= start) {
        end = Math.min(start + step, 24 * 60)
      }
      return {
        startMinutes: start,
        endMinutes: end
      }
    })

    const totalRows = computed(() => {
      const step = Number(slotMinutes.value) || 15
      const { startMinutes, endMinutes } = bookingWindow.value
      const duration = Math.max(endMinutes - startMinutes, step)
      return Math.max(1, Math.floor(duration / step))
    })

    function cellTime(day, row){
      const dt = new Date(day.date)
      dt.setHours(0, 0, 0, 0)
      const offset = bookingWindow.value.startMinutes + (row-1) * slotMinutes.value
      const safeOffset = Math.min(offset, bookingWindow.value.endMinutes - slotMinutes.value)
      dt.setMinutes(safeOffset)
      return dt
    }

    function weekdayISO(d){ // 0=Mon .. 6=Sun
      const js = d.getDay() // 0=Sun .. 6=Sat
      return (js+6)%7
    }

    function allowedForUser(s, e){
      if(!user.value || !user.value.id) return true
      const employee = employees.value.find(u=>u.id===user.value.id)
      if(!employee) return true
      if(employee.type !== 'external') return true
      const wd = weekdayISO(s)
      return (user.allowed_windows||[]).some(w=>{
        if(Number(w.weekday)!==wd) return false
        const [sh, sm] = String(w.start||'00:00').split(':').map(Number)
        const [eh, em] = String(w.end||'23:59').split(':').map(Number)
        const ds = new Date(s); ds.setHours(sh, sm, 0, 0)
        const de = new Date(s); de.setHours(eh, em, 0, 0)
        return s>=ds && e<=de
      })
    }

    function findReservationForSlot(start, end) {
      return reservations.value.find(r => 
        new Date(r.start_time) < end &&
        new Date(r.end_time) > start &&
        r.status !== 'cancelled' &&
        r.status !== 'rejected'
      )
    }

    function slotStateForRange(start, end) {
      const now = new Date()
      if (start < now) return 'blocked'
      const resv = findReservationForSlot(start, end)
      if(resv) return 'booked'
      if(!allowedForUser(start, end)) return 'blocked'
      if(!isWithinBookingHours(start, end)) return 'blocked'
      return 'free'
    }

    function slotState(day, row) {
      const s = cellTime(day, row)
      const e = addMinutes(s, slotMinutes.value)
      return slotStateForRange(s, e)
    }

    function cellClass(day, row){
      const s = cellTime(day, row)
      const e = addMinutes(s, slotMinutes.value)
      const base = slotStateForRange(s, e)
      if(base === 'free' && selection.value && s >= selection.value.start && e <= selection.value.end) return 'selected'
      return base
    }

    // Ê£ÄÊü•ÊòØÂê¶Âú®ÂèØÈ¢ÑÁ∫¶Êó∂Èó¥ÂÜÖ
    function isWithinBookingHours(start, end) {
      const { startMinutes, endMinutes } = bookingWindow.value
      const slotStart = start.getHours() * 60 + start.getMinutes()
      const slotEnd = end.getHours() * 60 + end.getMinutes()
      return slotStart >= startMinutes && slotEnd <= endMinutes
    }

    const selectedRangeText = computed(()=> selection.value ? `${selection.value.start.toLocaleString()} ‚Üí ${selection.value.end.toLocaleString()}` : '')
    const canReserve = computed(()=> {
      if(!(selectedInstrumentId.value && selection.value && user.value && user.value.id)) return false
      // ensure selection aligns to slot
      const aligned = selection.value.start.getMinutes()%slotMinutes.value===0 && selection.value.end.getMinutes()%slotMinutes.value===0
      return aligned && (selection.value.start >= new Date())
    })

    async function loadInstruments(){
      const { data } = await axios.get(`${api.value}/api/instruments`, { params: { q: search.value } })
      instruments.value = data
      if(!selectedInstrumentId.value && data[0]) selectInstrument(data[0].id)
    }

    async function loadEmployees(){
      if (!isLoggedIn.value) return
      try {
        const { data } = await axios.get(`${api.value}/api/employees`, { headers: headers.value })
        employees.value = data
      } catch (e) {
        console.error('Failed to load employees:', e)
      }
    }

    async function loadReservations(){
      if(!selectedInstrumentId.value) return
      const { data } = await axios.get(
        `${api.value}/api/instruments/${selectedInstrumentId.value}/reservations`,
        { headers: headers.value }
      )
      reservations.value = data
    }

    // ËøáÊª§ÊàëÁöÑÈ¢ÑÁ∫¶ÔºöÂè™ÊòæÁ§∫ÂΩìÂâçÁî®Êà∑ÁöÑÈ¢ÑÁ∫¶Ôºå‰∏îÂè™ÊòæÁ§∫ËøòÊ≤°ÂºÄÂßãÁöÑÈ¢ÑÁ∫¶
    const myReservations = computed(() => {
      if (!user.value || !user.value.id) return []
      const now = new Date()
      return reservations.value.filter(r => 
        r.employee_id === user.value.id && 
        new Date(r.start_time) > now &&
        r.status !== 'cancelled' && 
        r.status !== 'rejected'
      )
    })

    async function selectInstrument(id){
      selectedInstrumentId.value = id;
      try{
        const { data } = await axios.get(`${api.value}/api/instruments/${id}`)
        slotMinutes.value = Number(data.slot_minutes||15)
        currentInstrument.value = data
      }catch(e){ slotMinutes.value = 15 }
      loadReservations();
    }

    // Initialize selected instrument from URL (supports ?instrument_id= and #iid=)
    function initInstrumentFromURL(){
      try{
        const url = new URL(window.location.href)
        const q = url.searchParams.get('instrument_id')
        let fromHash = null
        if (location.hash) {
          const m = location.hash.match(/iid=(\d+)/)
          if (m && m[1]) fromHash = m[1]
        }
        const raw = q || fromHash
        const iid = raw ? Number(raw) : null
        if (iid && !Number.isNaN(iid)) {
          // Pre-select before instruments load; loadReservations will run after select
          selectInstrument(iid)
          hasInstrumentIdInURL.value = true
          try { viewDate.value = new Date(new Date().setHours(0,0,0,0)) } catch(e){}
        }
      }catch(e){ /* ignore */ }
    }

    function thisWeek(){
      const d=new Date()
      d.setHours(0,0,0,0)
      viewDate.value=d
      loadReservations()
    }
    function prevWeek(){
      const d=new Date(viewDate.value)
      d.setDate(d.getDate()-1)
      d.setHours(0,0,0,0)
      viewDate.value=d
      loadReservations()
    }
    function nextWeek(){
      const d=new Date(viewDate.value)
      d.setDate(d.getDate()+1)
      d.setHours(0,0,0,0)
      viewDate.value=d
      loadReservations()
    }

    async function createReservation(){
      if(!canReserve.value) return
      // ÈòªÊ≠¢È¢ÑÁ∫¶ÂΩìÂâçÊó∂Èó¥‰πãÂâç
      try{
        const now = new Date()
        if(selection.value && selection.value.start < now){ alert('‰∏çËÉΩÈ¢ÑÁ∫¶ÂΩìÂâçÊó∂Èó¥‰πãÂâçÁöÑÊó∂ÊÆµ'); return }
      }catch(e){}
      // ‰ª•ÊµèËßàÂô®Êú¨Âú∞Êó∂Èó¥‰∏∫ÂáÜÔºåÈÅøÂÖçÊó∂Â∑ÆÔºöÁªü‰∏ÄËΩ¨‰∏∫Êú¨Âú∞ ISO ‰∏çÂê´ Z
      const startISO = toLocalISOString(selection.value.start)
      const endISO = toLocalISOString(selection.value.end)
      await axios.post(`${api.value}/api/reservations`, {
        instrument_id: selectedInstrumentId.value,
        employee_id: user.value.id,
        start_time: startISO,
        end_time: endISO,
        notes: reservationNotes.value
      }, { headers: headers.value }).then(()=>{ selection.value=null; reservationNotes.value=''; loadReservations() }).catch(e=> alert(e.response?.data?.error||'error'))
    }

    async function approve(id){ await axios.post(`${api.value}/api/reservations/${id}/approve`, {}, { headers: headers.value }); loadReservations() }
    async function reject(id){ await axios.post(`${api.value}/api/reservations/${id}/reject`, {}, { headers: headers.value }); loadReservations() }
    async function cancel(id){ await axios.post(`${api.value}/api/reservations/${id}/cancel`, {}, { headers: headers.value }); loadReservations() }

    const showApiBar = (location.origin === 'null' || location.origin === 'file://' || location.protocol === 'file:')

    function goBack(){
      if (history.length > 1) history.back();
      else window.location.href = '/home.html'
    }
    
    // ËÆ§ËØÅÁõ∏ÂÖ≥ÂáΩÊï∞
    const checkLoginStatus = async () => {
      const savedToken = localStorage.getItem('token')
      const loginTime = localStorage.getItem('login_time')
      
      if (savedToken && loginTime) {
        // Ê£ÄÊü•tokenÊòØÂê¶ËøáÊúüÔºà30Â§©Ôºâ
        const thirtyDays = 30 * 24 * 60 * 60 * 1000
        if (Date.now() - parseInt(loginTime) < thirtyDays) {
          token.value = savedToken
        } else {
          // tokenËøáÊúüÔºåÊ∏ÖÈô§
          localStorage.removeItem('token')
          localStorage.removeItem('login_time')
          token.value = null
          return false
        }
      } else {
        return false
      }
      
      if (!token.value) return false
      try {
        const response = await axios.get(`${api.value}/api/auth/me`, { headers: headers.value })
        user.value = response.data
        isLoggedIn.value = true
        console.log('‚úÖ Ëá™Âä®ÁôªÂΩïÊàêÂäü:', user.value.name)
        return true
      } catch (e) {
        localStorage.removeItem('token')
        localStorage.removeItem('login_time')
        token.value = null
        isLoggedIn.value = false
        return false
      }
    }
    
    const goToLogin = () => {
      // ‰ªÖÂú®È£û‰π¶ÂÜÖÁΩÆÊµèËßàÂô®‰∏≠Ëá™Âä®ÊãâËµ∑ÁôªÂΩï
      const ua = navigator.userAgent || ''
      const inFeishu = /Lark|Feishu/i.test(ua)
      const url = new URL(window.location.href)
      const iid = url.searchParams.get('instrument_id') || (location.hash.match(/iid=(\d+)/)||[])[1] || ''
      const next = iid ? `/index.html?instrument_id=${iid}` : '/home.html'
      if (inFeishu) {
        fetch(`${api.value}/api/auth/feishu/login?next=${encodeURIComponent(next)}`)
          .then(r=>r.json())
          .then(j=>{ if(j.auth_url) window.location.href = j.auth_url; else alert('Êó†Ê≥ïÊãâËµ∑È£û‰π¶ÁôªÂΩï') })
          .catch(()=>{ alert('Êó†Ê≥ïÊãâËµ∑È£û‰π¶ÁôªÂΩï') })
      } else {
        alert('ËØ∑‰ΩøÁî®È£û‰π¶Êâ´Á†Å‰ª•Ëá™Âä®ËØÜÂà´ÊÇ®ÁöÑÁî®Êà∑ÂêçÂêéÂÜçÈ¢ÑÁ∫¶')
      }
    }
    
    // È¢ÑÁ∫¶È°µ‰∏çÊèê‰æõÈÄÄÂá∫ÁôªÂΩï
    
    const getRoleText = (role) => {
      const roleMap = {
        'admin': 'Ë∂ÖÁ∫ßÁÆ°ÁêÜÂëò',
        'user': 'ÊôÆÈÄöÁî®Êà∑'
      }
      return roleMap[role] || 'Êú™Áü•'
    }
    
    function saveAPI(){ localStorage.setItem('API', api.value); loadInstruments(); loadEmployees(); loadReservations() }
    function formatDT(s){ const d=new Date(s); return `${d.getMonth()+1}/${d.getDate()} ${d.getHours().toString().padStart(2,'0')}:${d.getMinutes().toString().padStart(2,'0')}` }
    
    function getMaintenanceTypeText(type) {
      const typeMap = {
        'general': 'Êó•Â∏∏Áª¥Êä§',
        'repair': 'Áª¥‰øÆ',
        'calibration': 'Ê†°ÂáÜ',
        'inspection': 'Â∑°Ê£Ä'
      }
      return typeMap[type] || 'Áª¥Êä§'
    }

    function getStatusCn(status){
      const m = { pending:'ÂÆ°Ê†∏‰∏≠', approved:'Â∑≤ÈÄöËøá', rejected:'Â∑≤È©≥Âõû', cancelled:'Â∑≤ÂèñÊ∂à' }
      return m[status] || status
    }

    async function probeAPI(){
      const candidates = [api.value, 'http://1.13.176.116', 'http://127.0.0.1:5011', 'http://localhost:5011'].filter(Boolean)
      for(const base of candidates){
        try{ await axios.get(`${base}/api/health`); api.value = base; localStorage.setItem('API', base); break }catch(e){}
      }
      if(!api.value){
        const input = prompt('ËØ∑ËæìÂÖ•ÂêéÁ´Ø API Âú∞ÂùÄ (Â¶Ç http://1.13.176.116)') || ''
        if(input){ api.value = input; localStorage.setItem('API', input) }
      }
    }

    async function seedIfEmpty(){
      await loadInstruments(); await loadEmployees()
      if(instruments.value.length===0){
        await axios.post(`${api.value}/api/instruments`, { name: 'DRL-III ÂØºÁÉ≠Á≥ªÊï∞ÊµãËØï‰ª™-1', brand:'Á§∫‰æãÂìÅÁâå', model:'X-1', category:'Ê£ÄÊµãËÆæÂ§á', location:'ÁîµÈïúÂÆ§ÂÜÖ' }, { headers: headers.value })
      }
      if(employees.value.length===0){
        const ext = { name:'Â§ñÈÉ®Áî®Êà∑A', type:'external', phone:'', allowed_windows:[{weekday:0,start:'09:00',end:'17:00'},{weekday:1,start:'09:00',end:'17:00'},{weekday:2,start:'09:00',end:'17:00'},{weekday:3,start:'09:00',end:'17:00'},{weekday:4,start:'09:00',end:'17:00'}] }
        const intUser = { name:'ÂÜÖÈÉ®Áî®Êà∑B', type:'internal', phone:'' }
        await axios.post(`${api.value}/api/employees`, ext, { headers: headers.value })
        await axios.post(`${api.value}/api/employees`, intUser, { headers: headers.value })
      }
      await loadInstruments(); await loadEmployees();
    }

    function saveRole(){ localStorage.setItem('role', role.value) }
    
    probeAPI().then(()=>{ initInstrumentFromURL(); loadInstruments(); loadEmployees(); })

    // Â§ÑÁêÜ‰ªéÂõûË∞ÉÂ∏¶ÂõûÁöÑ tokenÔºàÊîØÊåÅ‰ªéÈ£û‰π¶ÂõûË∑≥Âà∞Êú¨È°µÔºâ
    ;(function handleCallbackToken(){
      try{
        const params = new URLSearchParams(window.location.search)
        const t = params.get('token')
        const ok = params.get('success')
        if(t && ok === 'true'){
          localStorage.setItem('token', t)
          localStorage.setItem('login_time', Date.now().toString())
          token.value = t
          // Ê∏ÖÁêÜURL‰ΩÜ‰øùÁïô instrument_id
          const u = new URL(window.location.href)
          const iid = u.searchParams.get('instrument_id')
          const autologin = u.searchParams.get('autologin')
          const clean = new URL(window.location.origin + '/index.html')
          if(iid) clean.searchParams.set('instrument_id', iid)
          if(autologin) clean.searchParams.set('autologin', autologin)
          window.history.replaceState({}, document.title, clean.toString())
          // Ëé∑ÂèñÁî®Êà∑‰ø°ÊÅØÂπ∂Âà∑Êñ∞Êï∞ÊçÆ
          axios.get(`${api.value}/api/auth/me`, { headers: headers.value }).then(r=>{
            user.value = r.data
            isLoggedIn.value = true
            loadEmployees()
            loadReservations()
          }).catch(()=>{})
        }
      }catch(e){ /* ignore */ }
    })()

    // Mobile logic
    window.addEventListener('resize', () => { windowWidth.value = window.innerWidth })
    const isMobileReserve = computed(()=> hasInstrumentIdInURL.value && windowWidth.value < 768 )
    const mobileDateLabel = computed(()=> {
      const d = viewDate.value; return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`
    })
    function mobilePrevDay(){ const d=new Date(viewDate.value); d.setDate(d.getDate()-1); viewDate.value=d; loadReservations() }
    function mobileNextDay(){ const d=new Date(viewDate.value); d.setDate(d.getDate()+1); viewDate.value=d; loadReservations() }
    const dayReservations = computed(()=> {
      const start = new Date(viewDate.value)
      const end = new Date(viewDate.value); end.setDate(end.getDate()+1)
      return reservations.value.filter(r=> new Date(r.start_time) < end && new Date(r.end_time) > start)
    })
    const mobileSlots = computed(()=>{
      const slots = []
      const dayStart = new Date(viewDate.value)
      dayStart.setHours(0,0,0,0)
      const now = new Date()
      const { startMinutes, endMinutes } = bookingWindow.value
      for(let mins=startMinutes; mins<endMinutes; mins+=slotMinutes.value){
        const s = new Date(dayStart); s.setMinutes(mins)
        const e = new Date(s); e.setMinutes(e.getMinutes()+slotMinutes.value)
        const resv = reservations.value.find(r=> new Date(r.start_time) < e && new Date(r.end_time) > s && r.status !== 'cancelled' && r.status !== 'rejected')
        let className = 'free'
        if (s < now) {
          className = 'blocked'
        } else if (resv) {
          className = 'booked'
        } else if (!isWithinBookingHours(s, e)) {
          className = 'blocked'
        } else if (selection.value && s >= selection.value.start && e <= selection.value.end) {
          className = 'selected'
        }
        slots.push({ key: `${s.toISOString()}`, s, e, resv, className, label: `${String(s.getHours()).padStart(2,'0')}:${String(s.getMinutes()).padStart(2,'0')} - ${String(e.getHours()).padStart(2,'0')}:${String(e.getMinutes()).padStart(2,'0')}` })
      }
      return slots
    })
    function mobileClickSlot(slot){
      if(slot.resv || slot.className === 'blocked') return
      const s = slot.s, e = slot.e
      if(!selection.value) selection.value = { start: s, end: e }
      else if(e.getTime() === selection.value.start.getTime()) selection.value.start = s
      else if(s.getTime() === selection.value.end.getTime()) selection.value.end = e
      else selection.value = { start: s, end: e }
    }
    async function mobileReserve(){
      if(!isLoggedIn.value){
        const ua = navigator.userAgent || ''
        const inFeishu = /Lark|Feishu/i.test(ua)
        if (inFeishu) return goToLogin()
        alert('ËØ∑Áî®È£û‰π¶Êâ´Á†ÅÂêéÂÜçÊèê‰∫§È¢ÑÁ∫¶ÔºàÁî®‰∫éËØÜÂà´ÊÇ®ÁöÑÁî®Êà∑ÂêçÔºâ')
        return
      }
      if(!canReserve.value){ alert('ËØ∑ÈÄâÊã©ÂèØÁî®ÁöÑÊó∂Èó¥ÊÆµÂÜçÊèê‰∫§'); return }
      await createReservation()
    }

    function cellLabel(day,row){
      const s = cellTime(day,row); const e = addMinutes(s,slotMinutes.value)
      const r = findReservationForSlot(s, e)
      if(!r) return ''
      const name = r.employee_name || 'Â∑≤È¢ÑÁ∫¶'
      const note = (r.notes && String(r.notes).trim()) ? `Ôºà${r.notes}Ôºâ` : ''
      return `${name}${note}`
    }
    function cellTooltip(day,row){
      const s = cellTime(day,row); const e = addMinutes(s,slotMinutes.value)
      const r = findReservationForSlot(s, e)
      if(!r) return ''
      const name = r.employee_name || ''
      const note = (r.notes && String(r.notes).trim()) ? `Ôºà${r.notes}Ôºâ` : ''
      return `${name}${note} ${formatDT(r.start_time)}-${formatDT(r.end_time)}`
    }

    function cellPending(day,row){
      const s = cellTime(day,row); const e = addMinutes(s,slotMinutes.value)
      const r = findReservationForSlot(s, e)
      return !!(r && r.status === 'pending')
    }

    function rangeHasOnlyFreeRows(startRow, endRow) {
      const low = Math.min(startRow, endRow)
      const high = Math.max(startRow, endRow)
      for (let r = low; r <= high; r++) {
        if(slotState(activeDay.value, r) !== 'free') return false
      }
      return true
    }

    function updateSelectionRange(startRow, endRow) {
      const low = Math.min(startRow, endRow)
      const high = Math.max(startRow, endRow)
      const startTime = cellTime(activeDay.value, low)
      const endBase = cellTime(activeDay.value, high)
      selection.value = { start: startTime, end: addMinutes(endBase, slotMinutes.value) }
    }

    function onSlotMouseDown(row){
      if(slotState(activeDay.value, row) !== 'free') return
      dragState.active = true
      dragState.anchorRow = row
      updateSelectionRange(row, row)
    }

    function onSlotMouseEnter(row){
      if(!dragState.active || dragState.anchorRow === null) return
      if(!rangeHasOnlyFreeRows(dragState.anchorRow, row)) return
      updateSelectionRange(dragState.anchorRow, row)
    }

    function finishDrag(){
      dragState.active = false
      dragState.anchorRow = null
    }

    function onSlotMouseUp(){
      finishDrag()
    }

    function cancelDrag(){
      finishDrag()
    }

    function onSlotTouchStart(row){
      onSlotMouseDown(row)
    }

    function onSlotTouchMove(event){
      if(!dragState.active) return
      const touch = event.touches && event.touches[0]
      if(!touch) return
      const target = document.elementFromPoint(touch.clientX, touch.clientY)
      if(!target || !target.closest) return
      const slotEl = target.closest('.slot-single[data-row]')
      if(!slotEl) return
      const row = Number(slotEl.dataset.row)
      if(!row || Number.isNaN(row)) return
      onSlotMouseEnter(row)
    }

    const handleGlobalPointerUp = () => finishDrag()

    onMounted(() => {
      window.addEventListener('mouseup', handleGlobalPointerUp)
      window.addEventListener('touchend', handleGlobalPointerUp)
      window.addEventListener('touchcancel', handleGlobalPointerUp)
    })

    onBeforeUnmount(() => {
      window.removeEventListener('mouseup', handleGlobalPointerUp)
      window.removeEventListener('touchend', handleGlobalPointerUp)
      window.removeEventListener('touchcancel', handleGlobalPointerUp)
    })

    function formatMinutesRangeLabel(totalMinutes){
      const hh = Math.floor(totalMinutes/60)
      const mm = totalMinutes%60
      return `${String(hh).padStart(2,'0')}:${String(mm).padStart(2,'0')}`
    }

    function rowStartLabel(row){
      const start = bookingWindow.value.startMinutes + (row-1)*slotMinutes.value
      return formatMinutesRangeLabel(start)
    }

    function rowLabel(row){
      const start = bookingWindow.value.startMinutes + (row-1)*slotMinutes.value
      const end = Math.min(start + slotMinutes.value, bookingWindow.value.endMinutes)
      return `${formatMinutesRangeLabel(start)} - ${formatMinutesRangeLabel(end)}`
    }

    // ÂàùÂßãÂåñÊó∂Ê£ÄÊü•ÁôªÂΩïÁä∂ÊÄÅÔºõËã•ÁßªÂä®ËêΩÂú∞‰∏îÂ∏¶ autologin=1 ‰∏îÊú™ÁôªÂΩïÔºåÂàô‰ªÖÂú®È£û‰π¶ÂÜÖËá™Âä®ÊãâËµ∑
    checkLoginStatus().then((ok) => {
      if (isLoggedIn.value) {
        loadInstruments()
        loadEmployees()
      } else if (isMobileReserve.value) {
        try {
          const u = new URL(window.location.href)
          const autologin = u.searchParams.get('autologin')
          const ua = navigator.userAgent || ''
          const inFeishu = /Lark|Feishu/i.test(ua)
          if (autologin === '1' && inFeishu) { goToLogin() }
        } catch(e) { /* noop */ }
      }
    })
    
    return { api, showApiBar, saveAPI, instruments, employees, reservations, myReservations, search, selectedInstrumentId, selectInstrument, weekDays, weekTitle, prevWeek, nextWeek, thisWeek, cellClass, selectedRangeText, createReservation, canReserve, loadInstruments, approve, reject, cancel, formatDT, seedIfEmpty, cellLabel, cellTooltip, cellPending, totalRows, rowLabel, rowStartLabel, isLoggedIn, user, token, headers, checkLoginStatus, goToLogin, getRoleText, goBack, isMobileReserve, currentInstrument, mobileSlots, mobileClickSlot, mobileReserve, mobileDateLabel, mobilePrevDay, mobileNextDay, dayReservations, isWithinBookingHours, getMaintenanceTypeText, getStatusCn, reservationNotes, activeDay, onSlotMouseDown, onSlotMouseEnter, onSlotMouseUp, onSlotTouchStart, onSlotTouchMove, cancelDrag }
  }
}).mount('#app')
</script>
</body>
</html>
