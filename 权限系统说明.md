# 权限系统说明

本说明基于当前系统实现（后端 `backend/app.py` 与前端页面）整理，统一描述角色、数据访问与审批规则。本文是唯一生效的权限文档，其他同类文档已废弃。

## 角色与身份

- 超级管理员（super_admin）
  - 系统最高权限。具备系统级用户与仪器管理能力
- 管理员（admin）
  - 系统管理权限。具备用户与仪器管理能力
- 普通用户（user）
  - 可搜索仪器、查看预约、提交预约申请（需遵守仪器设置与时间规则）。
- 保管员（keeper）
  - 是仪器维度的角色（由仪器字段 `keeper_id` 指定）。可管理自己负责的仪器的预约审批（通过/驳回），不受跨仪器影响。

说明：管理员/超管与保管员是不同维度的权限。管理员/超管不自动拥有某台仪器的保管员权限。

## 仪器相关字段

- booking_enabled（"true"/"false"）
  - false 时暂停预约，前端不允许下单。
- requires_approval（"true"/"false"）
  - true 表示该仪器开启预约审批流程。
- keeper_id
  - 仪器保管员的用户 ID。用于审批权限与保管员直批通过规则。
- slot_minutes
  - 预约时间粒度（默认 15 分钟）。
- booking_start_time / booking_end_time（HH:MM）
  - 仪器可预约的每日时间窗口。预约的每个时间段必须完全落在该窗口内。

## 预约创建与状态流转

- 基本规则
  - 预约起止时间必须对齐仪器的 `slot_minutes`。
  - 不得预约当前时间之前的时段。
  - 与已存在的 approved/pending 预约不可冲突（后端冲突检测）。
  - 仪器维护中或暂停预约时不可预约。

- 状态（status）
  - pending：待审批（前端显示“审核中”）
  - approved：已通过
  - rejected：已驳回
  - cancelled：已取消

- 核心审批规则（与后端一致）
  - 当仪器 `requires_approval == "true"`：
    - 保管员本人为该仪器提交预约：直接置为 approved（跳过审批）。
    - 其他任意用户（包括管理员/超管）：置为 pending，需由该仪器保管员/管理员/超管审批。
  - 当仪器 `requires_approval != "true"`：
    - 任何用户提交预约均直接 approved。

- 审批权限
  - 仅“该仪器的保管员/管理员/超管”可对 pending 预约执行“通过/驳回”。

- 取消与修改
  - 预约人本人可取消自己的预约；管理员/超管也可取消任意预约。
  - 修改预约时间需满足：
    - 仍然对齐 `slot_minutes`。
    - 不与其他预约冲突。
    - 与创建逻辑一致地重新确定状态：
      - 开启审批：保管员本人修改 → approved；其他人修改 → pending。
      - 未开启审批：直接 approved。

## 前端展示与交互要点

- 网格视图（`frontend/index.html`）
  - 已预约格子显示预约人姓名。
  - 若该预约为 pending，则在姓名下方追加“审核中”小行提示（橙色）。
  - 仅“当前时间之后”且完全在可预约时间窗内的格子可点击选择。
  - “我的预约”列表将 pending 文案显示为“审核中”。

- 飞书扫码预约视图（`frontend/feishu_reserve.html`）
  - 当某时间段存在预约且状态为 pending，在预约人姓名与时间下方显示“审核中”。
  - 保持与网格视图一致的时间窗与冲突规则。

## 管理端与保管员能力

- 管理端（管理员/超管）
  - 用户管理、仪器管理、维护管理、预约记录导出等系统级能力。
  - 具备对非本人保管的仪器执行预约审批的权限。

- 保管员
  - 仅对自己保管的仪器拥有审批（通过/驳回）权限。
  - 可在预约管理中查看并处理该仪器的 pending 预约。

如需调整策略（例如允许管理员/超管作为兜底审批人），可在后端接口处放宽审批权限判断；本文所述为当前系统的默认与唯一生效策略。
