# 自动登录功能说明

## 功能概述

现在系统已经实现了完整的自动登录功能，用户登录一次后，在30天内访问任何页面都会自动登录，无需重复进行飞书授权。

## 工作原理

### 1. 登录状态存储
- **Token存储**：JWT token存储在浏览器的localStorage中
- **登录时间**：记录登录时间，用于判断token是否过期
- **有效期**：30天自动过期

### 2. 自动登录检查
每次访问页面时，系统会：
1. 检查localStorage中是否有有效的token
2. 验证token是否在30天有效期内
3. 如果有效，自动使用token获取用户信息
4. 如果无效或过期，清除登录信息

### 3. 页面跳转逻辑
- **登录页面**：如果已登录，自动跳转到首页
- **其他页面**：如果已登录，正常显示内容；如果未登录，显示登录按钮

## 使用体验

### 首次登录
1. 访问 `http://127.0.0.1:5011/login.html`
2. 点击"飞书扫码登录"
3. 完成飞书授权
4. 自动跳转到首页

### 后续访问
1. 访问任何页面（包括登录页面）
2. 系统自动检查登录状态
3. 如果已登录，直接显示内容
4. 如果未登录，显示登录按钮

### 登录页面行为
- **已登录用户**：显示"您已登录，正在跳转到首页..."，1秒后自动跳转
- **未登录用户**：显示"飞书扫码登录"按钮

## 技术实现

### 前端实现
```javascript
// 检查登录状态
function checkLoginStatus() {
    const savedToken = localStorage.getItem('token')
    const loginTime = localStorage.getItem('login_time')
    
    if (savedToken && loginTime) {
        // 检查token是否过期（30天）
        const thirtyDays = 30 * 24 * 60 * 60 * 1000
        if (Date.now() - parseInt(loginTime) < thirtyDays) {
            // 使用token自动登录
            return true
        } else {
            // token过期，清除
            localStorage.removeItem('token')
            localStorage.removeItem('login_time')
        }
    }
    return false
}
```

### 后端优化
- **用户缓存**：减少数据库查询
- **Token缓存**：提高验证速度
- **连接池优化**：提高并发性能

## 测试方法

### 1. 使用测试页面
访问 `http://127.0.0.1:5011/test_login.html` 可以查看：
- 当前登录状态
- Token信息
- 用户信息
- 操作日志

### 2. 测试步骤
1. 首次登录后，关闭浏览器
2. 重新打开浏览器，访问登录页面
3. 应该看到"您已登录，正在跳转到首页..."
4. 1秒后自动跳转到首页

### 3. 测试不同页面
- 登录页面：自动跳转
- 首页：直接显示内容
- 预约页面：直接显示内容
- 管理页面：根据权限显示内容

## 常见问题

### Q: 为什么登录页面还是会显示登录按钮？
A: 可能的原因：
1. Token已过期（超过30天）
2. 浏览器清除了localStorage
3. 服务器重启导致缓存丢失

### Q: 如何强制重新登录？
A: 方法：
1. 点击"退出登录"按钮
2. 清除浏览器localStorage
3. 等待30天自动过期

### Q: 登录状态在多个标签页之间同步吗？
A: 是的，localStorage在所有标签页之间共享，登录状态会自动同步。

### Q: 如何延长登录有效期？
A: 修改代码中的 `thirtyDays` 变量，单位是毫秒。

## 安全考虑

### Token安全
- JWT token包含用户ID和过期时间
- 30天自动过期，防止长期有效
- 服务器端验证token有效性

### 数据保护
- 敏感信息不存储在localStorage中
- 每次请求都验证token有效性
- 支持手动登出清除所有信息

## 配置说明

### 修改有效期
在代码中修改以下值：
```javascript
const thirtyDays = 30 * 24 * 60 * 60 * 1000; // 30天
```

### 修改跳转延迟
在登录页面修改：
```javascript
setTimeout(() => {
    window.location.href = '/home.html';
}, 1000); // 1秒延迟
```

## 故障排除

### 1. 自动登录不工作
- 检查浏览器控制台是否有错误
- 确认localStorage中有token和login_time
- 检查网络连接是否正常

### 2. 页面跳转异常
- 检查URL路径是否正确
- 确认服务器正在运行
- 查看浏览器控制台错误信息

### 3. 用户信息显示异常
- 清除localStorage重新登录
- 检查服务器日志
- 确认数据库连接正常

通过以上配置，用户现在可以享受"一次登录，30天免登录"的便捷体验！
